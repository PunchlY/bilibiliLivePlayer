<!DOCTYPE html>
<html lang='zh-CN' dir='ltr'>

<head>
    <meta charset='utf-8'>
    <title>bilibiliLiveSearch</title>

    <script src='./pako.js'></script>
    <script src='./hls.min.js'></script>
    <script src='./mpegts.js'></script>
    <script src='./bilibilisearch.js'></script>
    <script src='./bilibilichat.js'></script>
    <script src='./hlsplay.js'></script>
    <script src='./flvplay.js'></script>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
</head>

<body>
    <div id='search'>
        <div id='search-wrap'>
            <input name='search' type='text' id='key' placeholder='search'>
            <input name='search' type='button' id='get' value='>>'>
        </div>
        <div id='request'>
        </div>
    </div>
</body>

<script>
    $(function () {
        getData(location.search)
            .then(data => {
                if (data.keyword) {
                    let key = decodeURIComponent(data.keyword);
                    search.data.keyword = key;
                    document.title = `${key}_bilibiliLiveSearch`;
                    $('#key').val(key);
                }
                if (data.cors) {
                    let iscors = data.cors;
                    search.data.cors = iscors;
                    if (iscors == 0)
                        return get('http://api.bilibili.com/x/report/click/now')
                            .then(() => {
                                cors.set(false);
                            })
                            .catch(() => {
                                search.to({ cors: 1 });
                            });
                    if (iscors == 1) {
                        return cors.set(true)
                    };
                } else {
                    return search.to({ cors: 0 });
                }
            })
            .then(() => {
                return getSearchResponse(search.data.keyword, search.data.page);
            });
        $('#key').on('keypress', function (event) {
            if (event.keyCode == '13') {
                search.key($('#key').val());
            }
        })
        $('#get').on('click', function () {
            search.key($('#key').val());
        });
    });
    const search = {
        data: {},
        to: (data) => {
            for (let k in data) search.data[k] = data[k];
            mergeUrl('', search.data)
                .then(data => location.search = data.substr(1))
        },
        key: (key = '') => {
            if (key == '') return;
            search.to({ keyword: key });
        },
    }
    function getSearchResponse(key = '', page = 1) {
        if (key == '') return;
        $('#request').empty();
        $('#request').append(`<ul class='request' id=room>`);
        $('#request').append(`<ul class='request' id=user>`);
        searchResponse.get('live_room', key, page)
            .then(data => {
                data.forEach(function (element) {
                    $('#room').append(
                        `<li><a title=${element.roomid} href='https://live.bilibili.com/${element.roomid}' onclick='return openLive(${element.roomid})'>
                        ${element.title}-${element.uname}-${element.online}`
                    );
                });
            });
        searchResponse.get('live_user', key)
            .then(data => {
                data.forEach(function (element) {
                    $('#user').append(
                        `<li><a title=${element.roomid} href='https://live.bilibili.com/${element.roomid}' onclick='return openLive(${element.roomid})'>${element.is_live}-${element.uname}`
                    );
                });
            });
    }
    function openLive(room_id) {
        let obj = window.open(`./live.html?room_id=${room_id}`, '', 'height=250, width=250,toolbar=0,menubar=0,location=0');
        obj.document.close();
        return false;
    }
</script>

</html>