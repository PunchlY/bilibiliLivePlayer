<!DOCTYPE html>
<html lang='zh-CN' dir='ltr'>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <link rel="icon" href="https://www.bilibili.com/favicon.ico" type="image/x-icon" crossorigin="anonymous">
    <link rel="shortcut icon" href="https://www.bilibili.com/favicon.ico" type="image/x-icon" crossorigin="anonymous">

    <link rel="dns-prefetch" href="https://api.bilibili.com/">
    <link rel="dns-prefetch" href="https://json2jsonp.com/">

    <title>bilibiliLiveSearch</title>

    <script src='./bilibilisearch.js'></script>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
</head>

<body>
    <div id='search'>
        <div id='search-wrap'>
            <input name='search' type='text' id='key' placeholder='search'>
            <input name='search' type='button' id='get' value='>>'>
        </div>
        <div id='request'>
        </div>
    </div>
</body>

<script>
    $(function () {
        getData(location.search).then(data => {
            if (data.keyword) {
                let key = decodeURIComponent(data.keyword);
                search.data.keyword = key;
                document.title = `${key}_bilibiliLiveSearch`;
                $('#key').val(key);
            }
            if (data.type) {
                let type = data.type;
                search.data.type = type;
            }
            if (data.cors) {
                let iscors = data.cors;
                if (iscors == 0) {
                    search.data.cors = 0;
                } else if (iscors == 1) {
                    search.data.cors = 1;
                };
            }
        }).then(() => {
            if (search.data.cors == 0) {
                cors.set(false);
                return fetch('https://api.bilibili.com/x/report/click/now')
                    .catch(() => search.to({ cors: 1 }));
            } else if (search.data.cors == 0) {
                cors.set(true);
            }
        }).then(() => {
            return getSearchResponse[search.data.type](search.data.keyword, search.data.page);
        }).then(() => {
            $('#key').on('keypress', function (event) {
                if (event.keyCode == '13') {
                    search.key($('#key').val());
                }
            })
            $('#get').on('click', function () {
                search.key($('#key').val());
            });
        });
    });

    const search = {
        data: { type: 'live', cors: 0 },
        to: (data) => {
            for (let k in data) search.data[k] = data[k];
            mergeUrl('', search.data).then(data => location.search = data.substr(1));
        },
        key: (key = '') => {
            if (key == '') return;
            search.to({ keyword: key });
        },
    }

    const getSearchResponse = {
        live: (key = '', page = 1) => {
            if (key == '') return;
            $('#request').empty();
            $('#request').append(`<ul class='request' id=room>`);
            $('#request').append(`<ul class='request' id=user>`);
            searchResponse.get('live_room', key, page).then(data => {
                data.forEach(function (element) {
                    $('#room').append(
                        `<li><a title=${element.roomid} href='https://live.bilibili.com/${element.roomid}' onclick='return openLive(${element.roomid})'>
                        ${element.title}-${element.uname}-${element.online}`
                    );
                });
            });
            searchResponse.get('live_user', key).then(data => {
                data.forEach(function (element) {
                    $('#user').append(
                        `<li><a title=${element.roomid} href='https://live.bilibili.com/${element.roomid}' onclick='return openLive(${element.roomid})'>${element.is_live}-${element.uname}`
                    );
                });
            });
        },
        live_user: (key = '', page = 1) => {
            if (key == '') return;
            $('#request').empty()
            $('#request').append(`<ul class='request' id=user>`);
            searchResponse.get('live_user', key, page).then(data => {
                data.forEach(function (element) {
                    $('#user').append(
                        `<li><a title=${element.roomid} href='https://live.bilibili.com/${element.roomid}' onclick='return openLive(${element.roomid})'>${element.is_live}-${element.uname}`
                    );
                });
            });
        },
    }

    function openLive(room_id) {
        let obj = window.open(`./live.html?room_id=${room_id}`, '', 'height=250, width=250,toolbar=0,menubar=0,location=0');
        obj.document.close();
        return false;
    }
</script>

</html>