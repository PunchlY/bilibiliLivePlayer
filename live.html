<!DOCTYPE html>
<html lang='zh-CN' dir='ltr'>

<head>
    <meta charset='utf-8'>
    <title>bilibiliLivePlayer</title>

    <script src='./pako.js'></script>
    <script src='./hls.min.js'></script>
    <script src='./mpegts.js'></script>
    <script src='./bilibilisearch.js'></script>
    <script src='./bilibilichat.js'></script>
    <script src='./hlsplay.js'></script>
    <script src='./flvplay.js'></script>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
</head>

<body>
    <div id='live'>
        <div id='video'>
            <video id='live_play' width='100%' autoplay loop muted controls></video>
        </div>
        <div id='chat'>
        </div>
        <div id='info'>
        </div>
    </div>
</body>

<script>
    $(function () {
        getData(location.search)
            .then(data => {
                if (data.room_id) {
                    let room_id = data.room_id;
                    search.data.room_id = room_id;
                    document.title = `${room_id}`;
                }
                if (data.cors) {
                    let iscors = data.cors;
                    search.data.cors = iscors;
                    if (iscors == 0)
                        return get('http://api.bilibili.com/x/report/click/now')
                            .then(() => {
                                cors.set(false);
                            })
                            .catch(() => {
                                search.to({ cors: 1 });
                            });
                    if (iscors == 1) {
                        return cors.set(true)
                    };
                } else {
                    return search.to({ cors: 0 });
                }
            }).then(() => {
                getLive(search.data.room_id, 0);
            });
    });
    const search = {
        data: {},
        to: (data) => {
            for (let k in data) search.data[k] = data[k];
            mergeUrl('', search.data)
                .then(data => location.search = data.substr(1))
        },
    }
    function getLive(room_id, protocol = 0) {
        roomPlayInfo.get(room_id, protocol)
            .then(data => {
                data.forEach(function (element, index) {
                    $('#info').append(
                        `<li><a title=${element} onclick='play.protocol[${protocol}]("${element}")'>line${index}`
                    );
                });
                if (data[0]) play.protocol[protocol](data[0]);
            });
        return false;
    }
    function chat(room_id) {
        WebSocketTest(room_id);
    }

    const play = {
        protocol: [(videosrc) => play.flv(videosrc), (videosrc) => play.hls(videosrc)],
        flv: async function (videosrc) {
            await play.destroy();
            await flvLoad(document.getElementById('live_play'), videosrc);
        },
        hls: async function (videosrc) {
            await play.destroy();
            await hlsLoad(document.getElementById('live_play'), videosrc);
        },
        destroy: () => {
            flvDestroy();
            hlsDestroy();
        },
    }
</script>

</html>