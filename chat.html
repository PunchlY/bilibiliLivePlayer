<!DOCTYPE html>
<html lang='zh-CN' dir='ltr'>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="referrer" content="no-referrer">

    <link rel="icon" href="https://www.bilibili.com/favicon.ico" type="image/x-icon" crossorigin="anonymous">
    <link rel="shortcut icon" href="https://www.bilibili.com/favicon.ico" type="image/x-icon" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="chat.css">

    <title>bilibiliLiveChat</title>

    <script src='./bilibilisearch.js'></script>

    <script src='./pako.js'></script>
    <script src='./bilibilichat.js'></script>

    <script src='https://code.jquery.com/jquery-3.6.0.min.js'></script>
</head>

<body>
    <div id='chat'>
        <div id='danmu'>
            <div id='_danmu'>
            </div>
            <ul id='danmuInfo'>
            </ul>
        </div>
        <div id='interactWord'>
        </div>
    </div>
</body>

<script>
    $(function () {
        getData(location.search).then(data => {
            if (data.room_id) {
                let room_id = data.room_id;
                search.data.room_id = room_id;
                document.title = `${room_id}`;
            }
        }).then(() => {
            chat(search.data.room_id);
        }).then(() => {
            $('#interactWord').html(
                `<span class='interact'>; )</span>`
            );
        });
    });

    const num = {
        danmu: {
            max: 100,
            value: 0,
        },
    }
    const search = {
        data: {},
        to: (data) => {
            for (let k in data) search.data[k] = data[k];
            mergeUrl('', search.data).then(data => location.search = data.substr(1))
        },
    }
    function chat(room_id) {
        if (search.data.room_id) WebSocketTest(room_id);
    }
    function analyDanmuPacket(data) {
        //console.log(data);
        if (data.cmd == 'DANMU_MSG') {
            $('#danmuInfo').append(
                `<li class='danmuItem'><a class='name'href='https://space.bilibili.com/${data.info[2][0]}' onclick='return false'>${data.info[2][1]}: </a><span class='message'>${data.info[1]}</span>`
            );
            if (num.danmu.value++ >= num.danmu.max)
                $("ul li:eq(0)").remove();
            $('#danmu')[0].scrollTop = $('#danmu')[0].scrollHeight;
        } else if (data.cmd == 'INTERACT_WORD') {
            $('#interactWord').html(
                `<span class='interact'>进入直播间: ${data.data.uname}</span>`
            );
        }
    }
</script>

</html>